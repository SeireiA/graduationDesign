{"version":3,"file":"user.js","sources":["pages/user/user.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci91c2VyLnZ1ZQ"],"sourcesContent":["<script setup>\nimport UserInfoComponent from \"./component/userInfoComponent.vue\";\nimport LoginComponent from \"./component/loginComponent.vue\";\n\nimport WorkspaceComponent from \"./component/workspaceComponent.vue\";\nimport {setTokenValue} from \"@/store/token\";\nimport store from \"@/store\";\nimport {onLoad, onUnload} from '@dcloudio/uni-app'\nimport {nextTick, ref} from 'vue'\n\nimport {reqWechatLogin} from \"@/api/auth\";\nimport {reqGetWorkflowsWorksPage} from \"@/api/drawingWorks\";\nimport LoadingDataComponent from \"../../components/loadingDataComponent.vue\";\nimport TopButtonComponent from \"../../components/topButtonComponent.vue\";\nimport {reqGetTaskProgressList} from \"@/api/drawingTask\";\nimport env from \"@/env\";\nimport {reqRewarded} from \"@/api/ad\";\n\n\nlet videoAd= null\n\nconst isLoginLoading = ref(false)\n\nconst isWorkflowsWorksLoading = ref(false)\n\nconst workspaceActive = ref(0)\n\nconst workflowsWorksPageNum = ref(1)\n\nconst workflowsWorksData = ref([])\n\nconst intervalId = ref(null)\n\nconst isTaskStop = ref(false)\n\nconst drawingTaskData = ref([])\n\nconst isTopButtonShow = ref(false)\n\nconst workspaceRef = ref(null)\n\nconst scrollTop = ref(0)\n\nconst contentTop = ref(0)\n\nconst handleAdLoad = ()=>{\n  if (wx.createRewardedVideoAd) {\n\t  console.log(\"加载广告\")\n    videoAd = wx.createRewardedVideoAd({\n      adUnitId: env.adId\n    });\n    videoAd.onError(err => {\n      console.log(err);\n    });\n\n    videoAd.onClose(async (status) => {\n      if (status && status.isEnded || status === undefined) {\n        try {\n         await reqRewarded();\n          uni.showToast({\n            title: '奖励已发放',\n            icon: 'none'\n          });\n          await store.dispatch('fetchUserInfo')\n        } catch (e) {\n          console.log(e)\n          uni.showToast({\n            title: '获取奖励失败',\n            icon: 'none'\n          });\n        }\n\n      } else {\n        uni.showToast({\n          icon: 'none',\n          duration: 3000,\n          title: `请重新观看视频获得奖励`\n        });\n      }\n    });\n  }\n}\n\nconst handleScrollToLower = () => {\n  if (workspaceActive.value === 0) {\n    //刷新作品\n    handleGetWorkflowsWorksPage()\n  }\n}\n\nconst handleBackToTop = () => {\n  contentTop.value = scrollTop.value\n  nextTick(() => {\n    contentTop.value = 0\n  })\n}\n\nconst handlePageScroll = ((e) => {\n  scrollTop.value = e.detail.scrollTop\n  isTopButtonShow.value = e.detail.scrollTop > 600;\n})\n\nconst handleChangeWorkspaceActive = (e) => {\n  workspaceActive.value = e\n}\n\nconst handleGetWorkflowsWorksPage = async () => {\n  if (!isWorkflowsWorksLoading.value) {\n    try {\n      isWorkflowsWorksLoading.value = true\n      const {data} = await reqGetWorkflowsWorksPage(workflowsWorksPageNum.value);\n      if (data.records && data.records.length > 0) {\n        workflowsWorksPageNum.value = workflowsWorksPageNum.value + 1\n        let map = handleTreatmentWorkflowsWorks(data);\n        workflowsWorksData.value.push(...map);\n      }\n    } catch (e) {\n      console.log(e)\n    } finally {\n      setTimeout(() => {\n        isWorkflowsWorksLoading.value = false\n      }, 1000)\n    }\n  }\n}\n\nconst handleTreatmentWorkflowsWorks = (data) => {\n  return data.records.map(c => {\n    if (c.resultType === 'VIDEO') {\n      return {\n        workflowsWorksId: c.workflowsWorksId,\n        image: c.image += '?x-oss-process=video/snapshot,t_1,f_jpg',\n        resultType: c.resultType\n      }\n    } else if (c.resultType === 'MODEL') {\n      return {\n        workflowsWorksId: c.workflowsWorksId,\n        image: '/static/svg/model.svg',\n        resultType: c.resultType\n      }\n\n    } else if (c.resultType === 'AUDIO') {\n      return {\n        workflowsWorksId: c.workflowsWorksId,\n        image: '/static/svg/music.svg',\n        resultType: c.resultType\n      }\n    } else if(c.resultType === 'IMAGE') {\n      return {\n        workflowsWorksId: c.workflowsWorksId,\n        image: c.image+'?x-oss-process=image/resize,m_lfit,w_300,h_300/quality,q_80',\n        resultType: c.resultType\n      }\n    }\n    return c\n  });\n}\n\nconst handleWechatLogin = () => {\n  uni.vibrateShort()\n  isLoginLoading.value = true\n  uni.login({\n    async success(res) {\n      try {\n        const {data} = await reqWechatLogin({\n          code: res.code\n        })\n        setTokenValue(data)\n        await store.dispatch('fetchUserInfo')\n        //刷新作品\n        await handleGetWorkflowsWorksPage()\n\t\tawait handleListeningTask()\n        uni.showToast({icon: 'none', duration: 3000, title: \"欢迎使用 TYPE STARTS\"});\n      } catch (e) {\n        uni.showToast({\n          icon: 'none',\n          duration: 6000,\n          title: e.msg\n        });\n      } finally {\n        isLoginLoading.value = false\n      }\n    }\n  })\n\n}\n\nconst handleListeningTask = async () => {\n  intervalId.value = setInterval(async () => {\n    if (!isTaskStop.value) {\n      isTaskStop.value = true\n      try {\n        const {data} = await reqGetTaskProgressList();\n        drawingTaskData.value = data.map(c => {\n\t\n          if (c.resultType === 'VIDEO') {\n            c.url += '?x-oss-process=video/snapshot,t_1,f_jpg'\n          } else if (c.resultType === 'MODEL') {\n            c.url = '/static/svg/model.svg'\n          } else if (c.resultType === 'AUDIO') {\n            c.url = '/static/svg/audio.svg'\n          }\n          return c\n        })\n      } catch (e) {\n        console.log(e)\n      } finally {\n        isTaskStop.value = false\n      }\n    }\n  }, 3000);\n}\n\nconst handleRewardedAds = async () => {\n  if (videoAd) {\n    videoAd.show().catch(() => {\n      // 广告拉取失败，重试\n      videoAd.load().then(() => {\n        videoAd.show();\n      });\n    })\n  }\n}\n\nonLoad(async () => {\n  handleAdLoad()\n  if (store.getters.userInfo) {\n    await handleListeningTask()\n    await store.dispatch('fetchUserInfo')\n    await handleGetWorkflowsWorksPage()\n  }\n\n  uni.$on(\"WORKFLOWS_WORKS:REFRESH\", async () => {\n    workflowsWorksPageNum.value = 1\n    workflowsWorksData.value = []\n    workspaceRef.value.handleWorkflowsWorksRefresh()\n    if (!isWorkflowsWorksLoading.value) {\n      try {\n        isWorkflowsWorksLoading.value = true\n        const {data} = await reqGetWorkflowsWorksPage(workflowsWorksPageNum.value);\n        if (data.records && data.records.length > 0) {\n          workflowsWorksPageNum.value = workflowsWorksPageNum.value + 1\n          let map = handleTreatmentWorkflowsWorks(data);\n          workflowsWorksData.value.push(...map);\n          workspaceRef.value.handleWorkflowsWorksRefresh()\n        }\n      } catch (e) {\n        console.log(e)\n      } finally {\n        setTimeout(() => {\n          isWorkflowsWorksLoading.value = false\n        }, 1000)\n      }\n    }\n  })\n})\n\nonUnload(() => {\n  clearInterval(intervalId);\n  uni.$off(\"WORKFLOWS_WORKS:REFRESH\")\n})\n\n</script>\n\n\n<template>\n  <view>\n    <LoginComponent v-show=\"!(store.getters.userInfo)\" :isLoading=\"isLoginLoading\" @login=\"handleWechatLogin\"/>\n    <TopButtonComponent :isShow=\"isTopButtonShow\" @clickTop=\"handleBackToTop\"/>\n    <LoadingDataComponent :is-loading=\"isWorkflowsWorksLoading\"/>\n    <scroll-view v-show=\"store.getters.userInfo\" id=\"scroll\" :scrollTop=\"contentTop\" class=\"scroll\" lower-threshold=\"10\"\n                 scroll-with-animation=\"true\"\n                 scroll-y=\"true\"\n                 @scroll=\"handlePageScroll\"\n                 @scrolltolower=\"handleScrollToLower()\"\n    >\n      <UserInfoComponent @rewardedAds=\"handleRewardedAds\"/>\n      <WorkspaceComponent\n          v-if=\"store.getters.disguiseStatus\"\n          ref=\"workspaceRef\"\n          :drawingTaskData=\"drawingTaskData\"\n          :workflowsWorksData=\"workflowsWorksData\"\n          :workspaceActive=\"workspaceActive\"\n          @changeWorkspaceActive=\"handleChangeWorkspaceActive\"\n      />\n    </scroll-view>\n  </view>\n</template>\n\n<style lang=\"scss\" scoped>\n\n.scroll {\n  height: 100vh;\n}\n\n.workspace {\n  padding: 30rpx;\n  display: flex;\n  color: #909090;\n  font-weight: bold;\n  font-size: 25rpx\n}\n\n.workspace > view {\n  margin-right: 30rpx\n}\n\n.workspace-underline {\n  margin: 0 20rpx;\n  border-bottom: 5rpx solid #fedbe2;\n  padding-top: 10rpx\n}\n</style>\n","import MiniProgramPage from 'E:/0/beifen/0/0Files/2025答辩/ts-ts/miniProgram/pages/user/user.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","wx","uni","env","reqRewarded","store","nextTick","reqGetWorkflowsWorksPage","reqWechatLogin","setTokenValue","reqGetTaskProgressList","onLoad","onUnload"],"mappings":";;;;;;;;;;;;AACA,MAAM,oBAAoB,MAAW;AACrC,MAAM,iBAAiB,MAAW;AAElC,MAAM,qBAAqB,MAAW;AAQtC,MAAM,uBAAuB,MAAW;AACxC,MAAM,qBAAqB,MAAW;;;;AAMtC,QAAI,UAAS;AAEb,UAAM,iBAAiBA,cAAG,IAAC,KAAK;AAEhC,UAAM,0BAA0BA,cAAG,IAAC,KAAK;AAEzC,UAAM,kBAAkBA,cAAG,IAAC,CAAC;AAE7B,UAAM,wBAAwBA,cAAG,IAAC,CAAC;AAEnC,UAAM,qBAAqBA,cAAG,IAAC,EAAE;AAEjC,UAAM,aAAaA,cAAG,IAAC,IAAI;AAE3B,UAAM,aAAaA,cAAG,IAAC,KAAK;AAE5B,UAAM,kBAAkBA,cAAG,IAAC,EAAE;AAE9B,UAAM,kBAAkBA,cAAG,IAAC,KAAK;AAEjC,UAAM,eAAeA,cAAG,IAAC,IAAI;AAE7B,UAAM,YAAYA,cAAG,IAAC,CAAC;AAEvB,UAAM,aAAaA,cAAG,IAAC,CAAC;AAExB,UAAM,eAAe,MAAI;AACvB,UAAIC,cAAAA,KAAG,uBAAuB;AAC7BC,sBAAAA,MAAY,MAAA,OAAA,6BAAA,MAAM;AACjB,kBAAUD,cAAE,KAAC,sBAAsB;AAAA,UACjC,UAAUE,IAAG,IAAC;AAAA,QACpB,CAAK;AACD,gBAAQ,QAAQ,SAAO;AACrBD,wBAAAA,gDAAY,GAAG;AAAA,QACrB,CAAK;AAED,gBAAQ,QAAQ,OAAO,WAAW;AAChC,cAAI,UAAU,OAAO,WAAW,WAAW,QAAW;AACpD,gBAAI;AACH,oBAAME,OAAW,YAAA;AAChBF,4BAAAA,MAAI,UAAU;AAAA,gBACZ,OAAO;AAAA,gBACP,MAAM;AAAA,cAClB,CAAW;AACD,oBAAMG,YAAK,MAAC,SAAS,eAAe;AAAA,YACrC,SAAQ,GAAG;AACVH,4BAAAA,MAAY,MAAA,OAAA,6BAAA,CAAC;AACbA,4BAAAA,MAAI,UAAU;AAAA,gBACZ,OAAO;AAAA,gBACP,MAAM;AAAA,cAClB,CAAW;AAAA,YACF;AAAA,UAET,OAAa;AACLA,0BAAAA,MAAI,UAAU;AAAA,cACZ,MAAM;AAAA,cACN,UAAU;AAAA,cACV,OAAO;AAAA,YACjB,CAAS;AAAA,UACF;AAAA,QACP,CAAK;AAAA,MACF;AAAA,IACH;AAEA,UAAM,sBAAsB,MAAM;AAChC,UAAI,gBAAgB,UAAU,GAAG;AAE/B,oCAA6B;AAAA,MAC9B;AAAA,IACH;AAEA,UAAM,kBAAkB,MAAM;AAC5B,iBAAW,QAAQ,UAAU;AAC7BI,oBAAAA,WAAS,MAAM;AACb,mBAAW,QAAQ;AAAA,MACvB,CAAG;AAAA,IACH;AAEA,UAAM,mBAAoB,CAAC,MAAM;AAC/B,gBAAU,QAAQ,EAAE,OAAO;AAC3B,sBAAgB,QAAQ,EAAE,OAAO,YAAY;AAAA,IAC/C;AAEA,UAAM,8BAA8B,CAAC,MAAM;AACzC,sBAAgB,QAAQ;AAAA,IAC1B;AAEA,UAAM,8BAA8B,YAAY;AAC9C,UAAI,CAAC,wBAAwB,OAAO;AAClC,YAAI;AACF,kCAAwB,QAAQ;AAChC,gBAAM,EAAC,KAAI,IAAI,MAAMC,iBAAwB,yBAAC,sBAAsB,KAAK;AACzE,cAAI,KAAK,WAAW,KAAK,QAAQ,SAAS,GAAG;AAC3C,kCAAsB,QAAQ,sBAAsB,QAAQ;AAC5D,gBAAI,MAAM,8BAA8B,IAAI;AAC5C,+BAAmB,MAAM,KAAK,GAAG,GAAG;AAAA,UACrC;AAAA,QACF,SAAQ,GAAG;AACVL,wBAAAA,MAAA,MAAA,OAAA,8BAAY,CAAC;AAAA,QACnB,UAAc;AACR,qBAAW,MAAM;AACf,oCAAwB,QAAQ;AAAA,UACjC,GAAE,GAAI;AAAA,QACR;AAAA,MACF;AAAA,IACH;AAEA,UAAM,gCAAgC,CAAC,SAAS;AAC9C,aAAO,KAAK,QAAQ,IAAI,OAAK;AAC3B,YAAI,EAAE,eAAe,SAAS;AAC5B,iBAAO;AAAA,YACL,kBAAkB,EAAE;AAAA,YACpB,OAAO,EAAE,SAAS;AAAA,YAClB,YAAY,EAAE;AAAA,UACf;AAAA,QACP,WAAe,EAAE,eAAe,SAAS;AACnC,iBAAO;AAAA,YACL,kBAAkB,EAAE;AAAA,YACpB,OAAO;AAAA,YACP,YAAY,EAAE;AAAA,UACf;AAAA,QAEP,WAAe,EAAE,eAAe,SAAS;AACnC,iBAAO;AAAA,YACL,kBAAkB,EAAE;AAAA,YACpB,OAAO;AAAA,YACP,YAAY,EAAE;AAAA,UACf;AAAA,QACP,WAAc,EAAE,eAAe,SAAS;AAClC,iBAAO;AAAA,YACL,kBAAkB,EAAE;AAAA,YACpB,OAAO,EAAE,QAAM;AAAA,YACf,YAAY,EAAE;AAAA,UACf;AAAA,QACF;AACD,eAAO;AAAA,MACX,CAAG;AAAA,IACH;AAEA,UAAM,oBAAoB,MAAM;AAC9BA,oBAAAA,MAAI,aAAc;AAClB,qBAAe,QAAQ;AACvBA,oBAAAA,MAAI,MAAM;AAAA,QACR,MAAM,QAAQ,KAAK;AACjB,cAAI;AACF,kBAAM,EAAC,KAAI,IAAI,MAAMM,wBAAe;AAAA,cAClC,MAAM,IAAI;AAAA,YACpB,CAAS;AACDC,wBAAAA,cAAc,IAAI;AAClB,kBAAMJ,YAAK,MAAC,SAAS,eAAe;AAEpC,kBAAM,4BAA6B;AACzC,kBAAM,oBAAqB;AACrBH,gCAAI,UAAU,EAAC,MAAM,QAAQ,UAAU,KAAM,OAAO,mBAAkB,CAAC;AAAA,UACxE,SAAQ,GAAG;AACVA,0BAAAA,MAAI,UAAU;AAAA,cACZ,MAAM;AAAA,cACN,UAAU;AAAA,cACV,OAAO,EAAE;AAAA,YACnB,CAAS;AAAA,UACT,UAAgB;AACR,2BAAe,QAAQ;AAAA,UACxB;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IAEH;AAEA,UAAM,sBAAsB,YAAY;AACtC,iBAAW,QAAQ,YAAY,YAAY;AACzC,YAAI,CAAC,WAAW,OAAO;AACrB,qBAAW,QAAQ;AACnB,cAAI;AACF,kBAAM,EAAC,KAAI,IAAI,MAAMQ,gBAAAA;AACrB,4BAAgB,QAAQ,KAAK,IAAI,OAAK;AAEpC,kBAAI,EAAE,eAAe,SAAS;AAC5B,kBAAE,OAAO;AAAA,cACrB,WAAqB,EAAE,eAAe,SAAS;AACnC,kBAAE,MAAM;AAAA,cACpB,WAAqB,EAAE,eAAe,SAAS;AACnC,kBAAE,MAAM;AAAA,cACT;AACD,qBAAO;AAAA,YACjB,CAAS;AAAA,UACF,SAAQ,GAAG;AACVR,0BAAAA,MAAY,MAAA,OAAA,8BAAA,CAAC;AAAA,UACrB,UAAgB;AACR,uBAAW,QAAQ;AAAA,UACpB;AAAA,QACF;AAAA,MACF,GAAE,GAAI;AAAA,IACT;AAEA,UAAM,oBAAoB,YAAY;AACpC,UAAI,SAAS;AACX,gBAAQ,OAAO,MAAM,MAAM;AAEzB,kBAAQ,OAAO,KAAK,MAAM;AACxB,oBAAQ,KAAI;AAAA,UACpB,CAAO;AAAA,QACP,CAAK;AAAA,MACF;AAAA,IACH;AAEAS,kBAAAA,OAAO,YAAY;AACjB,mBAAc;AACd,UAAIN,YAAK,MAAC,QAAQ,UAAU;AAC1B,cAAM,oBAAqB;AAC3B,cAAMA,YAAK,MAAC,SAAS,eAAe;AACpC,cAAM,4BAA6B;AAAA,MACpC;AAEDH,0BAAI,IAAI,2BAA2B,YAAY;AAC7C,8BAAsB,QAAQ;AAC9B,2BAAmB,QAAQ,CAAE;AAC7B,qBAAa,MAAM,4BAA6B;AAChD,YAAI,CAAC,wBAAwB,OAAO;AAClC,cAAI;AACF,oCAAwB,QAAQ;AAChC,kBAAM,EAAC,KAAI,IAAI,MAAMK,iBAAwB,yBAAC,sBAAsB,KAAK;AACzE,gBAAI,KAAK,WAAW,KAAK,QAAQ,SAAS,GAAG;AAC3C,oCAAsB,QAAQ,sBAAsB,QAAQ;AAC5D,kBAAI,MAAM,8BAA8B,IAAI;AAC5C,iCAAmB,MAAM,KAAK,GAAG,GAAG;AACpC,2BAAa,MAAM,4BAA6B;AAAA,YACjD;AAAA,UACF,SAAQ,GAAG;AACVL,0BAAAA,MAAY,MAAA,OAAA,8BAAA,CAAC;AAAA,UACrB,UAAgB;AACR,uBAAW,MAAM;AACf,sCAAwB,QAAQ;AAAA,YACjC,GAAE,GAAI;AAAA,UACR;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IACH,CAAC;AAEDU,kBAAAA,SAAS,MAAM;AACb,oBAAc,UAAU;AACxBV,oBAAG,MAAC,KAAK,yBAAyB;AAAA,IACpC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnQD,GAAG,WAAW,eAAe;"}